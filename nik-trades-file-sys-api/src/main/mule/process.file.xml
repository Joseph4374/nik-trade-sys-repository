<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:file="http://www.mulesoft.org/schema/mule/file"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/file http://www.mulesoft.org/schema/mule/file/current/mule-file.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	
	<sub-flow name="process.fileSub_Flow" doc:id="49224d65-997e-4de2-9ad8-9f035dd93f24" >
		<logger level="INFO" doc:name="statr" doc:id="b07fb254-389a-42c3-86df-fbfb740035f8" message="request received"/>
		<choice doc:name="Choice" doc:id="d3132fc1-5afc-4bfa-afa4-e7079cfc72b4" >
			<when expression='#[payload."type" == "equity"]'>
				<logger level="INFO" doc:name="equity trade" doc:id="64152992-ce7b-4143-bb47-97e35e7fe1de" message="equity trade"/>
				<ee:transform doc:name="Set variable" doc:id="92053898-dcdc-4788-8eca-4092a574d131">
					<ee:message>
					</ee:message>
					<ee:variables >
						<ee:set-variable variableName="filePath" ><![CDATA[%dw 2.0
output application/json
---
p("filePath.equity")]]></ee:set-variable>
						<ee:set-variable variableName="fileName" ><![CDATA[%dw 2.0
output application/json
---
"equity_trade_"]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
				<flow-ref doc:name="file-write-Sub_Flow" doc:id="896d461a-c052-4e01-9d76-11857e846ab6" name="file-write-Sub_Flow"/>
			</when>
			<when expression='#[payload."type" == "fx"]'>
				<logger level="INFO" doc:name="fx trade" doc:id="8ee6f0dc-aefa-40b1-8c85-0e73012d7316" message="fx trade"/>
				<ee:transform doc:name="set variable" doc:id="e29e6546-28b3-4926-bdb0-3505eab26028">
					<ee:message>
					</ee:message>
					<ee:variables>
						<ee:set-variable variableName="filePath"><![CDATA[%dw 2.0
output application/json
---
p("filePath.fx")]]></ee:set-variable>
						<ee:set-variable variableName="fileName"><![CDATA[%dw 2.0
output application/json
---
"fx_trade_"]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
				<flow-ref doc:name="file-write-Sub_Flow" doc:id="25d4e69a-0617-4dbf-8b45-9d8b6476dbe9" name="file-write-Sub_Flow"/>
			</when>
			<otherwise >
				<logger level="INFO" doc:name="invalid trade" doc:id="8cac30e1-fbb7-426d-8ce8-d080c2355830" message="invalid trade"/>
			</otherwise>
		</choice>
		<ee:transform doc:name="set response" doc:id="b49d0df2-7577-4ffa-b3a9-ef267a710694" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	"message": "trade processed successfully"
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="end" doc:id="5143a6e3-51c9-4a44-9d26-c2f440f4012d" message="request processed successfully."/>
	</sub-flow>
	<sub-flow name="file-write-Sub_Flow" doc:id="23315923-6f63-4a46-8c46-d2f229b1878f" >
		<file:write doc:name="Write" doc:id="ee49b93b-1c13-4015-a60e-0487fe2c1eeb" config-ref="File_Config" path='#[vars.filePath ++ vars.fileName ++ (now() as String {format: "yyyy_MM_dd_HH_mm_ss"}) ++ ".json"]'/>
	</sub-flow>
</mule>
